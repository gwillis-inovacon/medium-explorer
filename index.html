<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .prose img { max-width: 100%; height: auto; }
        .prose pre { background: #1e293b; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { background: #334155; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .prose pre code { background: transparent; padding: 0; }
        .prose blockquote { border-left: 4px solid #10b981; padding-left: 1rem; font-style: italic; color: #9ca3af; }
        .prose h1, .prose h2, .prose h3 { color: #f1f5f9; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.75; }
        .prose ul, .prose ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .prose li { margin-bottom: 0.5rem; }
        .prose a { color: #10b981; text-decoration: underline; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div x-data="contentExplorer()" x-cloak class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-emerald-400">Content Explorer</h1>
                <div class="flex items-center gap-4">
                    <!-- Source Toggle -->
                    <div class="flex items-center bg-slate-700 rounded-lg p-1">
                        <button @click="switchSource('medium')"
                            :class="source === 'medium' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm font-medium transition">
                            Medium
                        </button>
                        <button @click="switchSource('devto')"
                            :class="source === 'devto' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm font-medium transition">
                            Dev.to
                        </button>
                    </div>
                    <div x-show="source === 'medium'" class="flex items-center gap-2">
                        <span class="text-sm text-slate-400">API Key:</span>
                        <span class="text-sm font-mono bg-slate-700 px-2 py-1 rounded">
                            <span x-text="apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + apiKey.slice(-4) : 'Not set'"></span>
                        </span>
                    </div>
                    <div x-show="source === 'devto'" class="text-sm text-slate-400">
                        Free API - No key required
                    </div>
                </div>
            </div>

            <!-- Search and Category Bar -->
            <div class="flex items-center gap-4 mt-4">
                <select x-model="selectedCategory" @change="loadContent()"
                    class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    <template x-for="cat in currentCategories" :key="cat.slug">
                        <option :value="cat.slug" x-text="cat.name"></option>
                    </template>
                </select>

                <div class="flex-1 flex gap-2">
                    <input type="text" x-model="searchQuery" @keyup.enter="performSearch()"
                        placeholder="Search users or articles..."
                        class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    <button @click="performSearch()"
                        class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                        Search
                    </button>
                </div>

                <select x-model="searchType" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                    <option value="users">Users</option>
                    <option value="articles">Articles</option>
                </select>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Writers Panel -->
            <aside class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col">
                <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="font-semibold text-slate-200">
                        <span x-show="!searchResults && source === 'medium'">Top Writers</span>
                        <span x-show="!searchResults && source === 'devto'">Top Authors</span>
                        <span x-show="searchResults">Search Results</span>
                    </h2>
                    <button x-show="searchResults" @click="clearSearch()"
                        class="text-xs text-slate-400 hover:text-slate-200">Clear</button>
                </div>

                <!-- Loading State -->
                <div x-show="loadingWriters" class="flex-1 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                </div>

                <!-- Writers List -->
                <div x-show="!loadingWriters" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <template x-for="writer in writers" :key="writer.id">
                        <div @click="selectWriter(writer)"
                            :class="{'ring-2 ring-emerald-500': selectedWriter?.id === writer.id}"
                            class="bg-slate-700 rounded-lg p-3 cursor-pointer hover:bg-slate-600 transition">
                            <div class="flex items-start gap-3">
                                <img :src="writer.image_url || writer.profile_image || 'https://via.placeholder.com/48'"
                                    class="w-12 h-12 rounded-full object-cover bg-slate-600">
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-medium text-slate-100 truncate" x-text="writer.fullname || writer.name || 'Loading...'"></h3>
                                    <p class="text-sm text-slate-400" x-text="'@' + (writer.username || writer.id)"></p>
                                    <div class="flex gap-3 mt-1 text-xs text-slate-400">
                                        <span x-show="writer.followers_count !== undefined" x-text="formatNumber(writer.followers_count) + ' followers'"></span>
                                        <span x-show="writer.location" x-text="writer.location"></span>
                                    </div>
                                </div>
                            </div>
                            <p x-show="writer.bio || writer.summary" class="text-xs text-slate-400 mt-2 line-clamp-2" x-text="writer.bio || writer.summary"></p>

                            <!-- Social Links - Medium -->
                            <div x-show="source === 'medium'" class="flex items-center gap-3 mt-2 pt-2 border-t border-slate-600">
                                <a :href="'https://medium.com/@' + writer.username"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-slate-300 hover:text-white flex items-center gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M13.54 12a6.8 6.8 0 01-6.77 6.82A6.8 6.8 0 010 12a6.8 6.8 0 016.77-6.82A6.8 6.8 0 0113.54 12zM20.96 12c0 3.54-1.51 6.42-3.38 6.42-1.87 0-3.39-2.88-3.39-6.42s1.52-6.42 3.39-6.42 3.38 2.88 3.38 6.42M24 12c0 3.17-.53 5.75-1.19 5.75-.66 0-1.19-2.58-1.19-5.75s.53-5.75 1.19-5.75C23.47 6.25 24 8.83 24 12z"/></svg>
                                    <span>Profile</span>
                                </a>
                                <a x-show="writer.twitter_username && writer.twitter_username.length > 0"
                                    :href="'https://twitter.com/' + writer.twitter_username"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-sky-400 hover:text-sky-300 flex items-center gap-1">
                                    <span>ùïè</span>
                                    <span x-text="'@' + writer.twitter_username"></span>
                                </a>
                                <a x-show="writer.tipping_link"
                                    :href="writer.tipping_link"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-amber-400 hover:text-amber-300">
                                    Tip/Support
                                </a>
                            </div>

                            <!-- Social Links - Dev.to -->
                            <div x-show="source === 'devto'" class="flex flex-wrap items-center gap-3 mt-2 pt-2 border-t border-slate-600">
                                <a :href="'https://dev.to/' + writer.username"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-slate-300 hover:text-white flex items-center gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M7.42 10.05c-.18-.16-.46-.23-.84-.23H6v4.36h.58c.37 0 .65-.08.84-.23.21-.17.31-.45.31-.93v-2c0-.49-.1-.77-.31-.97zm13.75-7.98H2.83C1.82 2.07 1 2.9 1 3.9v16.19c0 1.01.82 1.83 1.83 1.83h18.34c1.01 0 1.83-.82 1.83-1.83V3.9c0-1-.82-1.83-1.83-1.83zM8.9 14.3c0 .98-.41 1.88-1.8 1.88H5.1v-8h2.08c1.33 0 1.72.9 1.72 1.88v4.24zm5.02.46h-3.04v-1.8h1.85v-1.57h-1.85V10h3.04V8.54h-4.3v7.48h4.3v-1.26zm4.4-.09c0 .47-.14.85-.4 1.13-.27.3-.67.44-1.17.44-.47 0-.86-.1-1.17-.29v-1.38c.35.21.73.32 1.13.32.2 0 .35-.04.47-.12.12-.08.18-.21.18-.38v-.07c0-.14-.05-.27-.14-.39-.1-.12-.26-.24-.5-.35-.37-.17-.64-.36-.82-.57-.18-.21-.27-.48-.27-.8v-.05c0-.43.14-.78.42-1.03.29-.26.67-.39 1.14-.39.42 0 .8.08 1.15.24v1.3c-.32-.18-.66-.28-1-.28-.18 0-.32.04-.42.11-.1.07-.15.17-.15.3v.04c0 .12.05.23.15.33.1.11.27.22.5.35.38.19.66.4.83.63.18.23.26.51.26.83v.08z"/></svg>
                                    <span>Profile</span>
                                </a>
                                <a x-show="writer.twitter_username"
                                    :href="'https://twitter.com/' + writer.twitter_username"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-sky-400 hover:text-sky-300 flex items-center gap-1">
                                    <span>ùïè</span>
                                    <span x-text="'@' + writer.twitter_username"></span>
                                </a>
                                <a x-show="writer.github_username"
                                    :href="'https://github.com/' + writer.github_username"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                                    <span x-text="writer.github_username"></span>
                                </a>
                                <a x-show="writer.website_url"
                                    :href="writer.website_url"
                                    target="_blank"
                                    @click.stop
                                    class="text-xs text-emerald-400 hover:text-emerald-300 truncate max-w-[120px]"
                                    x-text="writer.website_url.replace(/^https?:\/\//, '')">
                                </a>
                            </div>
                        </div>
                    </template>

                    <div x-show="writers.length === 0 && !loadingWriters" class="text-center text-slate-500 py-8">
                        <p>No writers found</p>
                    </div>
                </div>

                <!-- Export Writers -->
                <div x-show="writers.length > 0" class="p-4 border-t border-slate-700 flex gap-2">
                    <button @click="exportWriters('csv')"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-xs font-medium transition">
                        Export CSV
                    </button>
                    <button @click="exportWriters('json')"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-xs font-medium transition">
                        Export JSON
                    </button>
                </div>
            </aside>

            <!-- Articles Panel -->
            <section class="flex-1 flex flex-col border-r border-slate-700 bg-slate-850">
                <div class="p-4 border-b border-slate-700 bg-slate-800">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-slate-200">
                            <span x-show="selectedWriter" x-text="'Articles by ' + (selectedWriter?.fullname || selectedWriter?.name || '')"></span>
                            <span x-show="!selectedWriter && searchArticles.length > 0">Search Results</span>
                            <span x-show="!selectedWriter && searchArticles.length === 0 && source === 'devto' && articles.length > 0">Top Articles</span>
                            <span x-show="!selectedWriter && searchArticles.length === 0 && articles.length === 0">Select a writer</span>
                        </h2>
                        <div x-show="articles.length > 0 || searchArticles.length > 0" class="flex items-center gap-2">
                            <select x-model="sortBy" @change="sortArticles()"
                                class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs">
                                <option value="reactions">Sort by Reactions</option>
                                <option value="date">Sort by Date</option>
                                <option value="reading_time">Sort by Read Time</option>
                            </select>
                            <button @click="exportArticles('csv')"
                                class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-xs transition">CSV</button>
                            <button @click="exportArticles('json')"
                                class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-xs transition">JSON</button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="loadingArticles" class="flex-1 flex items-center justify-center bg-slate-800/50">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                </div>

                <!-- Articles List -->
                <div x-show="!loadingArticles" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-800/50">
                    <template x-for="article in displayedArticles" :key="article.id">
                        <div @click="selectArticle(article)"
                            :class="{'ring-2 ring-emerald-500': selectedArticle?.id === article.id}"
                            class="bg-slate-700 rounded-lg p-4 cursor-pointer hover:bg-slate-600 transition">
                            <h3 class="font-medium text-slate-100 mb-1" x-text="article.title"></h3>
                            <p x-show="article.subtitle || article.description" class="text-sm text-slate-400 mb-2 line-clamp-1" x-text="article.subtitle || article.description"></p>
                            <div class="flex flex-wrap items-center gap-3 text-xs text-slate-300">
                                <span class="flex items-center gap-1">
                                    <span x-text="source === 'medium' ? 'üëè' : '‚ù§Ô∏è'"></span>
                                    <span x-text="formatNumber(article.claps || article.public_reactions_count || 0)"></span>
                                </span>
                                <span class="flex items-center gap-1">
                                    <span>üí¨</span>
                                    <span x-text="article.responses_count || article.comments_count || 0"></span>
                                </span>
                                <span class="flex items-center gap-1">
                                    <span>‚è±</span>
                                    <span x-text="(article.reading_time || article.reading_time_minutes || 0) + ' min'"></span>
                                </span>
                                <span class="text-slate-400" x-text="formatDate(article.published_at || article.published_timestamp)"></span>
                            </div>
                            <!-- Tags for Dev.to -->
                            <div x-show="article.tag_list && article.tag_list.length > 0" class="flex flex-wrap gap-1 mt-2">
                                <template x-for="tag in (article.tag_list || []).slice(0, 4)" :key="tag">
                                    <span class="text-xs bg-slate-600 text-slate-300 px-2 py-0.5 rounded" x-text="'#' + tag"></span>
                                </template>
                            </div>
                        </div>
                    </template>

                    <div x-show="displayedArticles.length === 0 && !loadingArticles"
                        class="flex-1 flex items-center justify-center text-slate-500 py-8">
                        <p x-show="selectedWriter">No articles found</p>
                        <p x-show="!selectedWriter">Select a writer to see their articles</p>
                    </div>
                </div>
            </section>

            <!-- Article Reader Panel -->
            <section class="w-[500px] flex flex-col bg-slate-800">
                <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="font-semibold text-slate-200">Article Reader</h2>
                    <div x-show="selectedArticle" class="flex items-center gap-2">
                        <button @click="readerTab = 'read'"
                            :class="readerTab === 'read' ? 'bg-emerald-600' : 'bg-slate-700 hover:bg-slate-600'"
                            class="px-3 py-1 rounded text-xs font-medium transition">Read</button>
                        <button @click="readerTab = 'source'"
                            :class="readerTab === 'source' ? 'bg-emerald-600' : 'bg-slate-700 hover:bg-slate-600'"
                            class="px-3 py-1 rounded text-xs font-medium transition">Source</button>
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="loadingContent" class="flex-1 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                </div>

                <!-- Article Content -->
                <div x-show="!loadingContent && selectedArticle" class="flex-1 overflow-y-auto">
                    <!-- Rendered View -->
                    <div x-show="readerTab === 'read'" class="p-6 prose prose-invert max-w-none"
                        x-html="renderedMarkdown"></div>

                    <!-- Source View -->
                    <div x-show="readerTab === 'source'" class="p-4">
                        <pre class="bg-slate-900 p-4 rounded-lg text-sm text-slate-300 whitespace-pre-wrap overflow-x-auto font-mono"
                            x-text="articleMarkdown"></pre>
                    </div>
                </div>

                <!-- Empty State -->
                <div x-show="!loadingContent && !selectedArticle"
                    class="flex-1 flex items-center justify-center text-slate-500">
                    <p>Select an article to read</p>
                </div>

                <!-- Action Buttons -->
                <div x-show="selectedArticle && articleMarkdown" class="p-4 border-t border-slate-700 flex gap-2">
                    <button @click="copyMarkdown()"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-sm font-medium transition flex items-center justify-center gap-2">
                        <span>üìã</span>
                        <span x-text="copied ? 'Copied!' : 'Copy Markdown'"></span>
                    </button>
                    <button @click="downloadMarkdown()"
                        class="flex-1 bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded text-sm font-medium transition flex items-center justify-center gap-2">
                        <span>‚¨á</span>
                        <span>Download .md</span>
                    </button>
                </div>
            </section>
        </div>

        <!-- Error Toast -->
        <div x-show="error" x-transition
            class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg max-w-md">
            <div class="flex items-start gap-3">
                <span class="text-xl">‚ö†Ô∏è</span>
                <div>
                    <p class="font-medium">Error</p>
                    <p class="text-sm" x-text="error"></p>
                </div>
                <button @click="error = null" class="ml-auto text-white/80 hover:text-white">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const MEDIUM_PROXY_URL = '/.netlify/functions/medium-proxy';
        const DEVTO_BASE_URL = 'https://dev.to/api';

        function contentExplorer() {
            return {
                // Config
                source: 'medium', // 'medium' or 'devto'

                // Categories
                mediumCategories: [
                    { name: 'Artificial Intelligence', slug: 'artificial-intelligence' },
                    { name: 'Programming', slug: 'programming' },
                    { name: 'Data Science', slug: 'data-science' },
                    { name: 'Machine Learning', slug: 'machine-learning' },
                    { name: 'Technology', slug: 'technology' },
                    { name: 'Software Engineering', slug: 'software-engineering' },
                    { name: 'Python', slug: 'python' },
                    { name: 'JavaScript', slug: 'javascript' },
                    { name: 'Web Development', slug: 'web-development' },
                    { name: 'Startup', slug: 'startup' },
                    { name: 'Product Management', slug: 'product-management' },
                    { name: 'UX Design', slug: 'ux' },
                ],
                devtoCategories: [
                    { name: 'Top (Week)', slug: 'top-week' },
                    { name: 'Top (Month)', slug: 'top-month' },
                    { name: 'Latest', slug: 'latest' },
                    { name: 'JavaScript', slug: 'javascript' },
                    { name: 'Python', slug: 'python' },
                    { name: 'AI', slug: 'ai' },
                    { name: 'Machine Learning', slug: 'machinelearning' },
                    { name: 'Web Development', slug: 'webdev' },
                    { name: 'React', slug: 'react' },
                    { name: 'Node.js', slug: 'node' },
                    { name: 'DevOps', slug: 'devops' },
                    { name: 'Career', slug: 'career' },
                ],
                selectedCategory: 'artificial-intelligence',

                // State
                writers: [],
                articles: [],
                searchArticles: [],
                selectedWriter: null,
                selectedArticle: null,
                articleMarkdown: '',
                renderedMarkdown: '',

                // UI State
                loadingWriters: false,
                loadingArticles: false,
                loadingContent: false,
                readerTab: 'read',
                sortBy: 'reactions',
                searchQuery: '',
                searchType: 'users',
                searchResults: false,
                copied: false,
                error: null,

                // Computed
                get currentCategories() {
                    return this.source === 'medium' ? this.mediumCategories : this.devtoCategories;
                },

                get displayedArticles() {
                    return this.searchArticles.length > 0 ? this.searchArticles : this.articles;
                },

                // Initialize
                init() {
                    this.loadContent();
                },

                // Switch source
                switchSource(newSource) {
                    if (this.source === newSource) return;
                    this.source = newSource;
                    this.selectedCategory = newSource === 'medium' ? 'artificial-intelligence' : 'top-week';
                    this.writers = [];
                    this.articles = [];
                    this.searchArticles = [];
                    this.selectedWriter = null;
                    this.selectedArticle = null;
                    this.searchResults = false;
                    this.loadContent();
                },

                // Load content based on source
                loadContent() {
                    if (this.source === 'medium') {
                        this.loadMediumTopWriters();
                    } else {
                        this.loadDevtoTopArticles();
                    }
                },

                // Medium API Helper (proxied through Netlify Function)
                async mediumApiCall(endpoint) {
                    const response = await fetch(`${MEDIUM_PROXY_URL}?endpoint=${encodeURIComponent(endpoint)}`);
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    return response.json();
                },

                // Dev.to API Helper
                async devtoApiCall(endpoint) {
                    const response = await fetch(`${DEVTO_BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    return response.json();
                },

                // Load Medium top writers
                async loadMediumTopWriters() {
                    this.loadingWriters = true;
                    this.searchResults = false;
                    this.writers = [];
                    this.articles = [];
                    this.error = null;

                    try {
                        const data = await this.mediumApiCall(`/top_writers/${this.selectedCategory}?count=10`);
                        const writerIds = data.top_writers || [];

                        this.writers = await Promise.all(
                            writerIds.map(async (id) => {
                                try {
                                    const userInfo = await this.mediumApiCall(`/user/${id}`);
                                    return { id, ...userInfo };
                                } catch (e) {
                                    return { id, fullname: 'Unknown', username: id };
                                }
                            })
                        );
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loadingWriters = false;
                    }
                },

                // Load Dev.to top articles and extract authors
                async loadDevtoTopArticles() {
                    this.loadingWriters = true;
                    this.loadingArticles = true;
                    this.searchResults = false;
                    this.writers = [];
                    this.articles = [];
                    this.error = null;

                    try {
                        let endpoint = '/articles?per_page=30';
                        const cat = this.selectedCategory;

                        if (cat === 'top-week') {
                            endpoint = '/articles?per_page=30&top=7';
                        } else if (cat === 'top-month') {
                            endpoint = '/articles?per_page=30&top=30';
                        } else if (cat === 'latest') {
                            endpoint = '/articles?per_page=30';
                        } else {
                            endpoint = `/articles?per_page=30&tag=${cat}&top=7`;
                        }

                        const articles = await this.devtoApiCall(endpoint);
                        this.articles = articles;

                        // Extract unique authors
                        const authorMap = new Map();
                        for (const article of articles) {
                            if (article.user && !authorMap.has(article.user.user_id)) {
                                authorMap.set(article.user.user_id, {
                                    id: article.user.user_id,
                                    username: article.user.username,
                                    name: article.user.name,
                                    profile_image: article.user.profile_image,
                                    twitter_username: article.user.twitter_username,
                                    github_username: article.user.github_username,
                                    website_url: article.user.website_url
                                });
                            }
                        }
                        this.writers = Array.from(authorMap.values()).slice(0, 15);

                        this.sortArticles();
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loadingWriters = false;
                        this.loadingArticles = false;
                    }
                },

                // Select a writer and load their articles
                async selectWriter(writer) {
                    this.selectedWriter = writer;
                    this.selectedArticle = null;
                    this.articleMarkdown = '';
                    this.renderedMarkdown = '';
                    this.searchArticles = [];
                    this.loadingArticles = true;
                    this.error = null;

                    try {
                        if (this.source === 'medium') {
                            const data = await this.mediumApiCall(`/user/${writer.id}/articles`);
                            const articleIds = data.associated_articles || [];

                            this.articles = await Promise.all(
                                articleIds.slice(0, 25).map(async (id) => {
                                    try {
                                        const articleInfo = await this.mediumApiCall(`/article/${id}`);
                                        return { id, ...articleInfo };
                                    } catch (e) {
                                        return { id, title: 'Unknown Article', claps: 0 };
                                    }
                                })
                            );
                        } else {
                            // Dev.to - fetch user details first for full profile
                            try {
                                const userDetails = await this.devtoApiCall(`/users/${writer.id}`);
                                Object.assign(writer, userDetails);
                            } catch (e) {
                                // Continue with existing data
                            }

                            const articles = await this.devtoApiCall(`/articles?username=${writer.username}&per_page=25`);
                            this.articles = articles;
                        }

                        this.sortArticles();
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loadingArticles = false;
                    }
                },

                // Sort articles
                sortArticles() {
                    const arr = this.searchArticles.length > 0 ? this.searchArticles : this.articles;
                    arr.sort((a, b) => {
                        if (this.sortBy === 'reactions') {
                            const aVal = a.claps || a.public_reactions_count || 0;
                            const bVal = b.claps || b.public_reactions_count || 0;
                            return bVal - aVal;
                        }
                        if (this.sortBy === 'date') {
                            const aDate = new Date(a.published_at || a.published_timestamp);
                            const bDate = new Date(b.published_at || b.published_timestamp);
                            return bDate - aDate;
                        }
                        if (this.sortBy === 'reading_time') {
                            const aVal = a.reading_time || a.reading_time_minutes || 0;
                            const bVal = b.reading_time || b.reading_time_minutes || 0;
                            return bVal - aVal;
                        }
                        return 0;
                    });
                },

                // Select an article and load its content
                async selectArticle(article) {
                    this.selectedArticle = article;
                    this.loadingContent = true;
                    this.articleMarkdown = '';
                    this.renderedMarkdown = '';
                    this.error = null;

                    try {
                        if (this.source === 'medium') {
                            const data = await this.mediumApiCall(`/article/${article.id}/markdown`);
                            this.articleMarkdown = data.markdown || '';
                        } else {
                            // Dev.to - fetch full article with body_markdown
                            const fullArticle = await this.devtoApiCall(`/articles/${article.id}`);
                            const body = fullArticle.body_markdown || '';
                            // Prepend title as H1 since Dev.to stores it separately
                            const title = fullArticle.title || article.title || '';
                            this.articleMarkdown = title ? `# ${title}\n\n${body}` : body;
                        }
                        this.renderedMarkdown = marked.parse(this.articleMarkdown);
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loadingContent = false;
                    }
                },

                // Search
                async performSearch() {
                    if (!this.searchQuery.trim()) return;

                    this.error = null;

                    if (this.searchType === 'users') {
                        this.loadingWriters = true;
                        this.searchResults = true;
                        this.writers = [];

                        try {
                            if (this.source === 'medium') {
                                const data = await this.mediumApiCall(`/search/users?query=${encodeURIComponent(this.searchQuery)}`);
                                const userIds = data.users || [];

                                this.writers = await Promise.all(
                                    userIds.slice(0, 10).map(async (id) => {
                                        try {
                                            const userInfo = await this.mediumApiCall(`/user/${id}`);
                                            return { id, ...userInfo };
                                        } catch (e) {
                                            return { id, fullname: 'Unknown', username: id };
                                        }
                                    })
                                );
                            } else {
                                // Dev.to doesn't have user search, search articles and extract authors
                                const articles = await this.devtoApiCall(`/articles?per_page=30&username=${encodeURIComponent(this.searchQuery)}`);
                                if (articles.length > 0 && articles[0].user) {
                                    const user = articles[0].user;
                                    const userDetails = await this.devtoApiCall(`/users/${user.user_id}`);
                                    this.writers = [{
                                        id: user.user_id,
                                        ...userDetails
                                    }];
                                } else {
                                    this.writers = [];
                                }
                            }
                        } catch (e) {
                            this.error = e.message;
                        } finally {
                            this.loadingWriters = false;
                        }
                    } else {
                        this.loadingArticles = true;
                        this.selectedWriter = null;
                        this.searchArticles = [];

                        try {
                            if (this.source === 'medium') {
                                const data = await this.mediumApiCall(`/search/articles?query=${encodeURIComponent(this.searchQuery)}`);
                                const articleIds = data.articles || [];

                                this.searchArticles = await Promise.all(
                                    articleIds.slice(0, 20).map(async (id) => {
                                        try {
                                            const articleInfo = await this.mediumApiCall(`/article/${id}`);
                                            return { id, ...articleInfo };
                                        } catch (e) {
                                            return { id, title: 'Unknown Article', claps: 0 };
                                        }
                                    })
                                );
                            } else {
                                // Dev.to article search by tag
                                const articles = await this.devtoApiCall(`/articles?per_page=20&tag=${encodeURIComponent(this.searchQuery)}`);
                                this.searchArticles = articles;
                            }

                            this.sortArticles();
                        } catch (e) {
                            this.error = e.message;
                        } finally {
                            this.loadingArticles = false;
                        }
                    }
                },

                // Clear search
                clearSearch() {
                    this.searchQuery = '';
                    this.searchResults = false;
                    this.searchArticles = [];
                    this.loadContent();
                },

                // Transform markdown for Discourse compatibility
                // Converts Dev.to Liquid tags to plain URLs for Onebox embedding
                transformForDiscourse(markdown) {
                    if (!markdown) return '';

                    let result = markdown;

                    // {% embed URL %} - generic embed
                    result = result.replace(/\{%\s*embed\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% twitter URL %} or {% tweet URL %}
                    result = result.replace(/\{%\s*(?:twitter|tweet)\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% youtube VIDEO_ID %} - convert to full URL
                    result = result.replace(/\{%\s*youtube\s+([a-zA-Z0-9_-]{11})\s*%\}/gi, '\nhttps://www.youtube.com/watch?v=$1\n');

                    // {% youtube URL %} - already a URL
                    result = result.replace(/\{%\s*youtube\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% vimeo VIDEO_ID %}
                    result = result.replace(/\{%\s*vimeo\s+(\d+)\s*%\}/gi, '\nhttps://vimeo.com/$1\n');

                    // {% codepen URL %}
                    result = result.replace(/\{%\s*codepen\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% codesandbox ID %}
                    result = result.replace(/\{%\s*codesandbox\s+([^\s%]+)\s*%\}/gi, '\nhttps://codesandbox.io/s/$1\n');

                    // {% github URL %} or {% gh URL %}
                    result = result.replace(/\{%\s*(?:github|gh)\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% gist URL or ID %}
                    result = result.replace(/\{%\s*gist\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');
                    result = result.replace(/\{%\s*gist\s+([^\s%]+)\s*%\}/gi, '\nhttps://gist.github.com/$1\n');

                    // {% link URL %} - internal Dev.to links
                    result = result.replace(/\{%\s*link\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% spotify URL %}
                    result = result.replace(/\{%\s*spotify\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% soundcloud URL %}
                    result = result.replace(/\{%\s*soundcloud\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');

                    // {% stackblitz ID %}
                    result = result.replace(/\{%\s*stackblitz\s+([^\s%]+)\s*%\}/gi, '\nhttps://stackblitz.com/edit/$1\n');

                    // {% replit URL or @user/repl %}
                    result = result.replace(/\{%\s*replit\s+(https?:\/\/[^\s%]+)\s*%\}/gi, '\n$1\n');
                    result = result.replace(/\{%\s*replit\s+@([^\s%]+)\s*%\}/gi, '\nhttps://replit.com/@$1\n');

                    // {% glitch ID %}
                    result = result.replace(/\{%\s*glitch\s+([^\s%]+)\s*%\}/gi, '\nhttps://glitch.com/edit/#!/$1\n');

                    // {% slideshare KEY %}
                    result = result.replace(/\{%\s*slideshare\s+([^\s%]+)\s*%\}/gi, '\nhttps://www.slideshare.net/slideshow/embed_code/$1\n');

                    // {% speakerdeck ID %}
                    result = result.replace(/\{%\s*speakerdeck\s+([^\s%]+)\s*%\}/gi, '\nhttps://speakerdeck.com/$1\n');

                    // Clean up multiple newlines
                    result = result.replace(/\n{3,}/g, '\n\n');

                    return result;
                },

                // Copy markdown to clipboard
                async copyMarkdown() {
                    try {
                        const markdown = this.transformForDiscourse(this.articleMarkdown);
                        await navigator.clipboard.writeText(markdown);
                        this.copied = true;
                        setTimeout(() => this.copied = false, 2000);
                    } catch (e) {
                        this.error = 'Failed to copy to clipboard';
                    }
                },

                // Download markdown file
                downloadMarkdown() {
                    const markdown = this.transformForDiscourse(this.articleMarkdown);
                    const blob = new Blob([markdown], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedArticle.title?.replace(/[^a-z0-9]/gi, '-') || 'article'}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                // Export writers
                exportWriters(format) {
                    const data = this.writers.map(w => ({
                        id: w.id,
                        name: w.fullname || w.name,
                        username: w.username,
                        followers: w.followers_count,
                        bio: w.bio || w.summary,
                        twitter: w.twitter_username,
                        github: w.github_username,
                        website: w.website_url
                    }));

                    if (format === 'json') {
                        this.downloadFile(JSON.stringify(data, null, 2), 'writers.json', 'application/json');
                    } else {
                        const csv = this.toCSV(data);
                        this.downloadFile(csv, 'writers.csv', 'text/csv');
                    }
                },

                // Export articles
                exportArticles(format) {
                    const arr = this.displayedArticles;
                    const data = arr.map(a => ({
                        id: a.id,
                        title: a.title,
                        subtitle: a.subtitle || a.description,
                        reactions: a.claps || a.public_reactions_count,
                        comments: a.responses_count || a.comments_count,
                        reading_time: a.reading_time || a.reading_time_minutes,
                        published_at: a.published_at || a.published_timestamp,
                        url: a.url,
                        tags: a.tag_list?.join(', ') || ''
                    }));

                    if (format === 'json') {
                        this.downloadFile(JSON.stringify(data, null, 2), 'articles.json', 'application/json');
                    } else {
                        const csv = this.toCSV(data);
                        this.downloadFile(csv, 'articles.csv', 'text/csv');
                    }
                },

                // Convert to CSV
                toCSV(data) {
                    if (data.length === 0) return '';
                    const headers = Object.keys(data[0]);
                    const rows = data.map(row =>
                        headers.map(h => {
                            const val = row[h] ?? '';
                            return `"${String(val).replace(/"/g, '""')}"`;
                        }).join(',')
                    );
                    return [headers.join(','), ...rows].join('\n');
                },

                // Download file helper
                downloadFile(content, filename, type) {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                // Format number (1000 -> 1k)
                formatNumber(num) {
                    if (!num) return '0';
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
                    return num.toString();
                },

                // Format date
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            };
        }
    </script>
</body>
</html>
